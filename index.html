<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Deicing Monitor - Top 100</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        h1 {
            font-size: 22px;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .subtitle {
            color: #4a90d9;
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .timestamp {
            color: #888;
            font-size: 12px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background: #4a90d9;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            touch-action: manipulation;
        }
        
        button:disabled {
            background: #555;
        }
        
        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #888;
            font-size: 14px;
        }
        
        .auto-refresh select {
            background: #252540;
            color: #fff;
            border: 1px solid #444;
            padding: 12px;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: #252540;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-card .count {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .summary-card .label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
        }
        
        .summary-card.active { border-left: 4px solid #e74c3c; }
        .summary-card.active .count { color: #e74c3c; }
        
        .summary-card.likely { border-left: 4px solid #f39c12; }
        .summary-card.likely .count { color: #f39c12; }
        
        .summary-card.possible { border-left: 4px solid #f1c40f; }
        .summary-card.possible .count { color: #f1c40f; }
        
        .summary-card.none { border-left: 4px solid #2ecc71; }
        .summary-card.none .count { color: #2ecc71; }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .section-header h2 {
            font-size: 16px;
            font-weight: 600;
        }
        
        .airport-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .airport-card {
            background: #252540;
            padding: 12px 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .airport-card .left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .airport-card .icao {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 14px;
            background: #1a1a2e;
            padding: 6px 8px;
            border-radius: 4px;
        }
        
        .airport-card .name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .airport-card .weather {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        
        .airport-card .temp {
            text-align: right;
        }
        
        .airport-card .temp-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .airport-card .temp-f {
            font-size: 11px;
            color: #888;
        }
        
        .flight-rules {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 3px;
        }
        
        .fr-vfr { background: #2ecc71; color: #000; }
        .fr-mvfr { background: #3498db; color: #fff; }
        .fr-ifr { background: #e74c3c; color: #fff; }
        .fr-lifr { background: #9b59b6; color: #fff; }
        
        .loading, .error {
            text-align: center;
            padding: 40px 20px;
        }
        
        .loading .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #333;
            border-top-color: #4a90d9;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error {
            background: #3d1f1f;
            border-radius: 8px;
            color: #ff6b6b;
        }
        
        .error button {
            margin-top: 15px;
            background: #c0392b;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #333;
            color: #555;
            font-size: 11px;
        }
        
        .status-msg {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .status-msg.info { background: #1a3a5c; color: #7db8eb; }
        .status-msg.warn { background: #5c4a1a; color: #ebd77d; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚úàÔ∏è Airport Deicing Monitor</h1>
            <div class="subtitle">Top 100 US Airports</div>
            <div class="timestamp" id="timestamp">Loading...</div>
        </header>
        
        <div class="controls">
            <button id="refreshBtn" onclick="fetchData()">üîÑ Refresh</button>
            <div class="auto-refresh">
                <span>Auto:</span>
                <select id="autoRefresh" onchange="setAutoRefresh()">
                    <option value="0">Off</option>
                    <option value="5">5m</option>
                    <option value="15">15m</option>
                    <option value="30" selected>30m</option>
                </select>
            </div>
        </div>
        
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <div>Fetching METAR data for 100 airports...</div>
            </div>
        </div>
        
        <footer>
            Data: Aviation Weather Center<br>
            Updates every ~1 minute at source
        </footer>
    </div>

    <script>
        // Top 100 US airports by passenger volume
        const AIRPORTS = [
            // Top 50
            'KATL', 'KLAX', 'KORD', 'KDFW', 'KDEN', 'KJFK', 'KSFO', 'KLAS', 'KMCO', 'KSEA',
            'KMIA', 'KPHX', 'KEWR', 'KIAH', 'KBOS', 'KMSP', 'KDTW', 'KFLL', 'KPHL', 'KLGA',
            'KBWI', 'KSLC', 'KDCA', 'KSAN', 'KTPA', 'KAUS', 'KIAD', 'KMDW', 'KHNL', 'KSTL',
            'KBNA', 'KOAK', 'KSMF', 'KSJC', 'KRDU', 'KMCI', 'KCLE', 'KPIT', 'KCLT', 'KPDX',
            'KIND', 'KCVG', 'KMSY', 'KSAT', 'KMKE', 'KBUF', 'KPBI', 'KABQ', 'KONT', 'KRSW',
            // 51-75
            'KBUR', 'KOMA', 'KRIC', 'KBDL', 'KSNA', 'KJAN', 'KCHS', 'KJAX', 'KORF', 'KANC',
            'KLIT', 'KELP', 'KTUS', 'KOKC', 'KTUL', 'KGRR', 'KDSM', 'KDAY', 'KSYR', 'KPVD',
            'KALB', 'KGSO', 'KPWM', 'KBTV', 'KROC',
            // 76-100
            'KBHM', 'KLEX', 'KSDF', 'KCMH', 'KCOS', 'KBOI', 'KFSD', 'KICT', 'KMSN', 'KLBB',
            'KFAR', 'KBIS', 'KDLH', 'KERI', 'KBGR', 'KAVL', 'KMYR', 'KSAV', 'KPNS', 'KFWA',
            'KLNK', 'KSGF', 'KXNA', 'KCRP', 'KABI'
        ];

        const AIRPORT_NAMES = {
            // Top 50
            'KATL': 'Atlanta', 'KLAX': 'Los Angeles', 'KORD': 'Chicago ORD',
            'KDFW': 'Dallas/Fort Worth', 'KDEN': 'Denver', 'KJFK': 'New York JFK',
            'KSFO': 'San Francisco', 'KLAS': 'Las Vegas', 'KMCO': 'Orlando',
            'KSEA': 'Seattle', 'KMIA': 'Miami', 'KPHX': 'Phoenix', 'KEWR': 'Newark',
            'KIAH': 'Houston IAH', 'KBOS': 'Boston', 'KMSP': 'Minneapolis',
            'KDTW': 'Detroit', 'KFLL': 'Fort Lauderdale', 'KPHL': 'Philadelphia',
            'KLGA': 'New York LGA', 'KBWI': 'Baltimore', 'KSLC': 'Salt Lake City',
            'KDCA': 'Washington DCA', 'KSAN': 'San Diego', 'KTPA': 'Tampa',
            'KAUS': 'Austin', 'KIAD': 'Washington IAD', 'KMDW': 'Chicago MDW',
            'KHNL': 'Honolulu', 'KSTL': 'St. Louis', 'KBNA': 'Nashville',
            'KOAK': 'Oakland', 'KSMF': 'Sacramento', 'KSJC': 'San Jose',
            'KRDU': 'Raleigh-Durham', 'KMCI': 'Kansas City', 'KCLE': 'Cleveland',
            'KPIT': 'Pittsburgh', 'KCLT': 'Charlotte', 'KPDX': 'Portland OR',
            'KIND': 'Indianapolis', 'KCVG': 'Cincinnati', 'KMSY': 'New Orleans',
            'KSAT': 'San Antonio', 'KMKE': 'Milwaukee', 'KBUF': 'Buffalo',
            'KPBI': 'West Palm Beach', 'KABQ': 'Albuquerque', 'KONT': 'Ontario CA',
            'KRSW': 'Fort Myers',
            // 51-75
            'KBUR': 'Burbank', 'KOMA': 'Omaha', 'KRIC': 'Richmond',
            'KBDL': 'Hartford', 'KSNA': 'Orange County', 'KJAN': 'Jackson MS',
            'KCHS': 'Charleston', 'KJAX': 'Jacksonville', 'KORF': 'Norfolk',
            'KANC': 'Anchorage', 'KLIT': 'Little Rock', 'KELP': 'El Paso',
            'KTUS': 'Tucson', 'KOKC': 'Oklahoma City', 'KTUL': 'Tulsa',
            'KGRR': 'Grand Rapids', 'KDSM': 'Des Moines', 'KDAY': 'Dayton',
            'KSYR': 'Syracuse', 'KPVD': 'Providence', 'KALB': 'Albany',
            'KGSO': 'Greensboro', 'KPWM': 'Portland ME', 'KBTV': 'Burlington VT',
            'KROC': 'Rochester',
            // 76-100
            'KBHM': 'Birmingham', 'KLEX': 'Lexington', 'KSDF': 'Louisville',
            'KCMH': 'Columbus OH', 'KCOS': 'Colorado Springs', 'KBOI': 'Boise',
            'KFSD': 'Sioux Falls', 'KICT': 'Wichita', 'KMSN': 'Madison',
            'KLBB': 'Lubbock', 'KFAR': 'Fargo', 'KBIS': 'Bismarck',
            'KDLH': 'Duluth', 'KERI': 'Erie', 'KBGR': 'Bangor',
            'KAVL': 'Asheville', 'KMYR': 'Myrtle Beach', 'KSAV': 'Savannah',
            'KPNS': 'Pensacola', 'KFWA': 'Fort Wayne', 'KLNK': 'Lincoln',
            'KSGF': 'Springfield MO', 'KXNA': 'NW Arkansas', 'KCRP': 'Corpus Christi',
            'KABI': 'Abilene'
        };

        const FROZEN_PRECIP = ['SN', 'FZRA', 'FZFG', 'FZDZ', 'PL', 'GR', 'GS', 'IC', 'SG'];
        const ALL_PRECIP = [...FROZEN_PRECIP, 'RA', 'DZ', 'SHRA', 'TSRA', 'SHSN'];

        let refreshInterval = null;

        const CORS_PROXIES = [
            (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
            (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
            (url) => url
        ];

        function parseMetar(metar) {
            if (!metar || metar.length < 10) return null;

            const result = {
                raw: metar,
                icao: null,
                temp_c: null,
                weather: [],
                visibility: 10,
                ceiling: null,
                flight_rules: 'VFR',
                frozen_precip: false,
                has_precip: false,
                has_moisture: false
            };

            const icaoMatch = metar.match(/\b(K[A-Z]{3})\b/);
            if (icaoMatch) result.icao = icaoMatch[1];
            else return null;

            const tempMatch = metar.match(/\s(M?\d{2})\/(M?\d{2})\s/);
            if (tempMatch) {
                const tempStr = tempMatch[1];
                result.temp_c = tempStr.startsWith('M') ? -parseInt(tempStr.slice(1)) : parseInt(tempStr);
            }

            const visMatch = metar.match(/\s(\d+)\s?SM\s/);
            if (visMatch) result.visibility = parseInt(visMatch[1]);
            else if (metar.match(/\d\/\d+SM/)) result.visibility = 0.5;

            for (const code of ALL_PRECIP) {
                if (metar.includes(code)) {
                    result.weather.push(code);
                    result.has_precip = true;
                    if (FROZEN_PRECIP.includes(code)) result.frozen_precip = true;
                }
            }

            if (metar.match(/\sBR\b/) || metar.match(/\sFG\b/)) {
                result.has_moisture = true;
                if (metar.includes(' BR')) result.weather.push('BR');
                if (metar.includes(' FG')) result.weather.push('FG');
            }

            const cloudMatches = metar.matchAll(/(BKN|OVC)(\d{3})/g);
            for (const match of cloudMatches) {
                const alt = parseInt(match[2]) * 100;
                if (result.ceiling === null || alt < result.ceiling) {
                    result.ceiling = alt;
                }
            }

            const vis = result.visibility;
            const ceil = result.ceiling;
            if ((ceil !== null && ceil < 500) || vis < 1) result.flight_rules = 'LIFR';
            else if ((ceil !== null && ceil < 1000) || vis < 3) result.flight_rules = 'IFR';
            else if ((ceil !== null && ceil < 3000) || vis < 5) result.flight_rules = 'MVFR';

            return result;
        }

        function categorize(parsed) {
            if (parsed.temp_c === null) return 'unknown';
            
            const temp = parsed.temp_c;
            
            if (temp <= 0 && parsed.frozen_precip) return 'active';
            if (parsed.weather.includes('FZRA') || parsed.weather.includes('FZDZ')) return 'active';
            if (temp <= 0 && parsed.has_precip) return 'likely';
            if (temp <= 0 && parsed.has_moisture) return 'likely';
            if (temp <= 0) return 'possible';
            if (temp <= 3 && parsed.has_precip) return 'marginal';
            return 'none';
        }

        function tempToF(c) {
            return Math.round(c * 9/5 + 32);
        }

        async function tryFetch(url, proxyIndex = 0) {
            if (proxyIndex >= CORS_PROXIES.length) {
                throw new Error('All fetch methods failed');
            }
            
            const proxyUrl = CORS_PROXIES[proxyIndex](url);
            
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 20000);
                
                const response = await fetch(proxyUrl, { 
                    signal: controller.signal,
                    headers: { 'Accept': 'text/plain' }
                });
                clearTimeout(timeout);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const text = await response.text();
                if (!text || text.length < 50 || !text.includes('METAR') && !text.match(/K[A-Z]{3}/)) {
                    throw new Error('Invalid response');
                }
                return text;
            } catch (e) {
                console.log(`Proxy ${proxyIndex} failed:`, e.message);
                return tryFetch(url, proxyIndex + 1);
            }
        }

        async function fetchData() {
            const btn = document.getElementById('refreshBtn');
            const content = document.getElementById('content');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';
            
            content.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Fetching METAR data for 100 airports...</div>
                </div>
            `;

            try {
                const ids = AIRPORTS.join(',');
                const baseUrl = `https://aviationweather.gov/api/data/metar?ids=${ids}&format=raw`;
                
                const text = await tryFetch(baseUrl);
                const metars = text.trim().split('\n').filter(m => m.length > 10 && m.match(/K[A-Z]{3}/));
                
                if (metars.length === 0) {
                    throw new Error('No valid METAR data received');
                }
                
                const parsed = metars.map(parseMetar).filter(p => p !== null);
                
                const categories = { active: [], likely: [], possible: [], marginal: [], none: [] };
                for (const p of parsed) {
                    const cat = categorize(p);
                    if (categories[cat]) categories[cat].push(p);
                }

                for (const cat in categories) {
                    categories[cat].sort((a, b) => (a.temp_c ?? 99) - (b.temp_c ?? 99));
                }

                renderResults(categories, parsed.length);
                
                const now = new Date();
                document.getElementById('timestamp').textContent = 
                    `Updated: ${now.toLocaleTimeString()} | ${parsed.length} airports reporting`;

            } catch (error) {
                content.innerHTML = `
                    <div class="error">
                        <strong>Unable to load data</strong><br><br>
                        ${error.message}<br><br>
                        <small>This can happen due to network issues or API availability.</small>
                        <br>
                        <button onclick="fetchData()">Try Again</button>
                    </div>
                `;
            }

            btn.disabled = false;
            btn.textContent = 'üîÑ Refresh';
        }

        function renderResults(categories, total) {
            const content = document.getElementById('content');
            
            let html = `
                <div class="summary">
                    <div class="summary-card active">
                        <div class="count">${categories.active.length}</div>
                        <div class="label">üî¥ Active</div>
                    </div>
                    <div class="summary-card likely">
                        <div class="count">${categories.likely.length}</div>
                        <div class="label">üü† Likely</div>
                    </div>
                    <div class="summary-card possible">
                        <div class="count">${categories.possible.length}</div>
                        <div class="label">üü° Possible</div>
                    </div>
                    <div class="summary-card none">
                        <div class="count">${categories.none.length}</div>
                        <div class="label">üü¢ Clear</div>
                    </div>
                </div>
            `;

            if (categories.active.length > 0) {
                html += renderSection('üî¥ Active Deicing', categories.active);
            }
            if (categories.likely.length > 0) {
                html += renderSection('üü† Likely Deicing', categories.likely);
            }
            if (categories.possible.length > 0) {
                html += renderSection('üü° Possible (Below Freezing)', categories.possible);
            }

            if (categories.active.length === 0 && categories.likely.length === 0 && categories.possible.length === 0) {
                html += `<div class="status-msg info">‚úÖ No airports currently reporting deicing conditions</div>`;
            }

            content.innerHTML = html;
        }

        function renderSection(title, airports) {
            let html = `
                <div class="section">
                    <div class="section-header"><h2>${title}</h2></div>
                    <div class="airport-list">
            `;

            for (const apt of airports) {
                const name = AIRPORT_NAMES[apt.icao] || apt.icao;
                const wx = apt.weather.length > 0 ? apt.weather.join(' ') : '‚Äî';
                const frClass = `fr-${apt.flight_rules.toLowerCase()}`;
                
                html += `
                    <div class="airport-card">
                        <div class="left">
                            <div class="icao">${apt.icao}</div>
                            <div>
                                <div class="name">${name}</div>
                                <div class="weather">${wx} <span class="flight-rules ${frClass}">${apt.flight_rules}</span></div>
                            </div>
                        </div>
                        <div class="temp">
                            <div class="temp-value">${apt.temp_c}¬∞</div>
                            <div class="temp-f">${tempToF(apt.temp_c)}¬∞F</div>
                        </div>
                    </div>
                `;
            }

            html += '</div></div>';
            return html;
        }

        function setAutoRefresh() {
            const mins = parseInt(document.getElementById('autoRefresh').value);
            if (refreshInterval) clearInterval(refreshInterval);
            if (mins > 0) {
                refreshInterval = setInterval(fetchData, mins * 60 * 1000);
            }
        }

        // Start
        fetchData();
        setAutoRefresh();
    </script>
</body>
</html>
